(function(){"use strict";for(var e in window.X509={DefaultType2_RSA:"2048",DefaultType2_ECC:"P-256",SupportECCType2:{"P-256":"prime256v1","P-384":"secp384r1","P-521":"secp521r1"},SupportECCType2Names:function(){var e=[];for(var t in X509.SupportECCType2)e.push(X509.SupportECCType2[t]);return e},KeyGenerate:function(e,t,r,s){var n=0;if("RSA"==e)n={publicExponent:new Uint8Array([1,0,1]),name:"RSASSA-PKCS1-v1_5",modulusLength:+t,hash:"SHA-256"};else{if("ECC"!=e)return void s("Not support "+e);n={name:"ECDSA",namedCurve:t}}crypto.subtle.generateKey(n,!0,["sign","verify"]).then(function(e){crypto.subtle.exportKey("jwk",e.privateKey).then(function(e){r(X509.KeyExport(e))}).catch(function(e){s(Lang("此浏览器不支持导出"+n.name+"+PKCS#8格式密钥：","This browser does not support exporting "+n.name+"+PKCS#8 format keys: ")+e.message)})}).catch(function(e){s(Lang("此浏览器不支持生成"+n.name+"：","This browser does not support generating "+n.name+": ")+e.message)})},KeyParse:function(e,t,r,s){var n={},a=function(e){n.error=e,r(e,n)};if(!/BEGIN\s*(RSA|EC)?\s*(PUBLIC|PRIVATE)\s*KEY/.test(e))return a(Lang("不是RSA或ECC密钥","Not an RSA or ECC key"));n.type="EC"==RegExp.$1?"ECC":RegExp.$1;var i,p,o=!!RegExp.$1,y="PUBLIC"==RegExp.$2;if(y&&s)return a(Lang("不是私钥","Is not a private key"));try{var u=null,S=ASN1.ParsePEM(e);if(n.asn1=S,o){if("RSA"==n.type)u=S;else if("ECC"==n.type){if(y)return a(Lang("不支持ECC PKCS#1格式公钥","ECC PKCS#1 format public key is not supported"));var h=S.sub[2].sub[0].oid;n.type2=ASN1.OID[h]||"",u=S}}else{var f=y?0:1,l=S.sub[f].sub[0].oid;h=S.sub[f].sub[1].oid;n.type=ASN1.OID[l]||"",n.type2=ASN1.OID[h]||"",u="ECC"==n.type&&y?S:(new ASN1).parse(S.sub[f+1].bytes)}n.paramAsn1=u}catch(e){return a(Lang("密钥解析失败：","Key resolution failed: ")+e.message)}if("RSA"==n.type){f=y?0:1;n.param={n:u.sub[f].bytes,e:u.sub[f+1].bytes,d:y?null:u.sub[f+2].bytes};for(var C="p,q,dp,dq,qi".split(","),E=0;E<5;E++)n.param[C[E]]=y?null:u.sub[f+3+E].bytes;n.type2=8*n.param.n.length+""}else{if("ECC"!=n.type)return a(Lang("不支持的密钥类型：","Unsupported key type: ")+l);if(!X509.SupportECCType2[n.type2])return a(Lang("只支持"+X509.SupportECCType2Names().join("、")+"曲线的ECC密钥","ECC key only supported for "+X509.SupportECCType2Names().join(",")+" curve"));if(y)var A=u.sub[1].bytes;else f=o?3:2,A=u.sub[f].sub[0].bytes;if(4!=A[0])return a("ECC !0x04: "+A[0]);var g=(A.length-1)/2;n.param={x:A.slice(1,1+g),y:A.slice(1+g),d:y?null:u.sub[1].bytes}}for(var c in n.isPKCS1=o,n.hasPrivate=!y,n.pem=e,"RSA"==n.type?(i={publicExponent:new Uint8Array(n.param.n.buffer),name:"RSASSA-PKCS1-v1_5",modulusLength:+n.type2,hash:"SHA-256"},p={kty:"RSA",alg:"RS256"}):"ECC"==n.type&&(i={name:"ECDSA",namedCurve:n.type2},p={kty:"EC",crv:n.type2}),p=Object.assign(p,{ext:!0,key_ops:[y?"verify":"sign"]}),n.param)n.param[c]&&(p[c]=Bytes2UrlB64(n.param[c]));crypto.subtle.importKey("jwk",p,i,!0,[y?"verify":"sign"]).then(function(e){n.key=e,t(n)}).catch(function(e){a(Lang("密钥转成CryptoKey失败：","Failed to convert key to CryptoKey: ")+e.message)})},PublicKeyJwk:function(e){var t=e.param;if("RSA"==e.type)return{e:Bytes2UrlB64(t.e),kty:"RSA",n:Bytes2UrlB64(t.n)};if("ECC"==e.type)return{crv:e.type2,kty:"EC",x:Bytes2UrlB64(t.x),y:Bytes2UrlB64(t.y)};throw new Error("Jwk: "+e.type)},KeyExport:function(e,t,r){var s="KeyExport: ",n=ASN1.S,a=ASN1.V,i=e.param,p=i&&e.type,o=e.type2;if(!i){if(!e.kty)throw new Error(s+"bad key");p="EC"==e.kty?"ECC":e.kty,"ECC"==p&&(o=e.crv)}var y=("ECC"==p?"x,y,d":"n,e,d,p,q,dp,dq,qi").split(",");if(!i){i={};for(var u=0;u<y.length;u++){var S=y[u],h=e[S];h&&(i[S]=UrlB642Bytes(h))}}var f,l=!t&&i.d;if("RSA"==p){var C=n(48,a(2,i.n),a(2,i.e));if(l){C.sub.splice(0,0,a(2,[0]));for(u=2;u<y.length;u++)C.push(a(2,i[y[u]]))}f=C.toBytes()}else{if("ECC"!=p)throw new Error(s+p);var E=new Uint8Array(1+2*i.x.length);E[0]=4,E.set(i.x,1),E.set(i.y,1+i.x.length),f=l?n(48,a(2,[1]),a(4,i.d),n(161,a(3,E))).toBytes():E}var A=n(48,a(6,ASN1.OID2Bytes(ASN1.OID[p])),"RSA"==p?a(5,[]):a(6,ASN1.OID2Bytes(ASN1.OID[o])));if(l)var g=n(48,a(2,[0]),A,a(4,f));else g=n(48,A,a(3,f));if(2==r)return g;if(f=g.toBytes(),1==r)return f;var c=Bytes2Base64(f).replace(/(.{64})/g,"$1\n").trim(),v=l?"PRIVATE":"PUBLIC";return"-----BEGIN "+v+" KEY-----\n"+c+"\n-----END "+v+" KEY-----"},CreateCSR:function(e,t,r,s,n){var a=ASN1.S,i=ASN1.V;try{var p=X509.KeyExport(e,!0,2)}catch(e){return n(e.message)}for(var o=a(48),y=0;y<r.length;y++)o.push(i(130,Str2Bytes(r[y])));var u=a(48,i(2,[0]),a(48,a(49,a(48,i(6,ASN1.OID2Bytes("2.5.4.3")),i(12,Str2Bytes(t))))),p,a(160,a(48,i(6,ASN1.OID2Bytes("1.2.840.113549.1.9.14")),a(49,a(48,a(48,i(6,ASN1.OID2Bytes("2.5.29.17")),i(4,o.toBytes()))))))),S=u.toBytes(),h={name:"ECDSA",hash:"SHA-256"};"RSA"==e.type&&(h={name:"RSASSA-PKCS1-v1_5"}),crypto.subtle.sign(h,e.key,S).then(function(t){var r=new Uint8Array(t);if("ECC"==e.type){var n=r.subarray(0,e.param.x.length),p=r.subarray(e.param.x.length);r=a(48,i(2,n),i(2,p)).toBytes()}var o=a(48,u,a(48,i(6,ASN1.OID2Bytes(ASN1.OID["SHA256_"+e.type])),"RSA"==e.type?i(5,[]):null),i(3,r)),y=o.toBytes(),S=Bytes2Base64(y).replace(/(.{64})/g,"$1\n").trim();s("-----BEGIN CERTIFICATE REQUEST-----\n"+S+"\n-----END CERTIFICATE REQUEST-----")}).catch(function(e){n("CSR sign:"+e.message)})}},window.ASN1=function(e,t){this.sub=[],e&&this.setTag(e),t&&this.setBytes(t)},ASN1.S=function(e){for(var t=new ASN1(e),r=1,s=arguments;r<s.length;r++)s[r]&&t.push(s[r]);return t},ASN1.V=function(e,t){return new ASN1(e,t)},ASN1.ParsePEM=function(e){return(new ASN1).parsePEM(e)},ASN1.TagNames={"01":"BOOLEAN","02":"INTEGER","03":"BIT_STRING","04":"OCTET_STRING","05":"NULL","06":"OID","0C":"UTF8String",13:"Printable_String",17:"UTCTime",18:"GeneralizedTime",30:"SEQUENCE",31:"SET"},ASN1.OID={"1.2.840.113549.1.1.1":"RSA","1.2.840.113549.1.1.11":"SHA256_RSA","1.2.840.10045.2.1":"ECC","1.2.840.10045.4.3.2":"SHA256_ECC","1.2.840.10045.3.1.7":"P-256","1.3.132.0.34":"P-384","1.3.132.0.35":"P-521"},ASN1.OID)ASN1.OID[ASN1.OID[e]]=e;ASN1.OID2Bytes=function(e){var t=e.split("."),r=[],s=+t[0],n=+t[1];if(!/^[\d\.]+$/.test(e)||t.length<3||s>2||40*s+n>255)throw new Error("bad oid: "+e);r.push(40*s+n);for(var a=2,i=t.length;a<i;a++){for(var p=+t[a],o=[];p>=128;)o.push(p%128),p/=128;o.push(p),o.reverse();for(var y=0,u=o.length-1;y<=u;y++)y!=u?r.push(128+o[y]):r.push(o[y])}return new Uint8Array(r)},ASN1.OID2Text=function(e){var t="",r=e[0],s=r<80?r<40?0:1:2;t+=s+"."+(r-40*s);for(var n=1,a=e.length;n<a;){for(var i=0;n<a;){var p=e[n++];if(i*=128,!(p>=128)){i+=p;break}i+=p-128}t+="."+i}return t},ASN1.ParseSize=function(e,t){var r=t[e[0]++],s=0;if(r<128)s=r;else if(128==r)s=-404;else for(var n=0,a=127&r;n<a;n++)s=256*s+t[e[0]++];if(s<0||s>t.length-e[0])throw new Error("ASN.1 Bad size "+s);return s},ASN1.ParseBlock=function(e,t,r){for(r=r||[];e[0]<t.length;){var s=e[0],n=new ASN1,a=t[e[0]++],i=ASN1.ParseSize(e,t);if(0!=(32&a))n.parse(t.slice(s,e[0]+i));else{var p=t.slice(e[0],e[0]+i);2!=a&&3!=a||p.length>1&&0==p[0]&&(p=p.slice(1)),n.setTag(a),n.setBytes(p)}r.push(n),e[0]+=i}return r},ASN1.PEM2Bytes=function(e){e=e.replace(/[\s\r\n]/g,"");var t=/^-+BEGIN\w*-+([^-]+)-+END\w+-+$/i.exec(e);try{return Base642Bytes(t[1])}catch(e){throw new Error(Lang("不是pem格式。","Not a pem format."))}},ASN1.prototype={setTag:function(e){var t=(e<16?"0":"")+e.toString(16).toUpperCase();this.tag=e,this.tagTxt=t,this.tagName=ASN1.TagNames[t]||"0x"+t},setBytes:function(e){if(null==e.length||null==e.slice&&null==e.subarray)throw new Error("Not Array");6==this.tag&&(this.oid=ASN1.OID2Text(e)),12!=this.tag&&19!=this.tag||(this.string=Bytes2Str(e)),this.bytes=e},push:function(e){if(!e.parsePEM)throw new Error("Not ASN1");return this.sub.push(e),this},parsePEM:function(e){return this.parse(ASN1.PEM2Bytes(e))},parse:function(e){var t=[0];if(0==(32&e[0]))throw new Error("ASN.1 parse: Not SEQ");this.setTag(e[t[0]++]);var r=ASN1.ParseSize(t,e);return e=e.slice(t[0],t[0]+r),this.setBytes(e),ASN1.ParseBlock([0],e,this.sub),this},toBytes:function(e){var t=[],r=0;if(this.sub.length)for(var s=0;s<this.sub.length;s++){var n=this.sub[s].toBytes();t.push(n),r+=n.length}else this.bytes&&this.bytes.length&&((2==this.tag&&this.bytes[0]>=128||3==this.tag)&&(t.push([0]),r++),t.push(this.bytes),r+=this.bytes.length);if(!e){n=[];var a=r;if(a<128)n.push(a);else{for(;a>255;)n.push(255&a),a>>=8;n.push(255&a),n.push(128+n.length)}n.push(this.tag),n.reverse(),t.splice(0,0,n),r+=n.length}var i=new Uint8Array(r),p=0;for(s=0;s<t.length;s++){n=t[s];i.set(n,p),p+=n.length}return i}}})();