(function(){"use strict";var e="ACME_HTML_choice_acmeURL",t="ACME_HTML_input_domains",a="ACME_HTML_input_email",n={};window.initMainUI=function(){$(".eccCurveNames").html(X509.SupportECCType2Names().join(Lang("、",", "))),$(".donateBtnIco").html(unescape("%uD83D%uDE18")),$(".versionBox").html(Lang("版本: "+Version,"")),/mobile/i.test(navigator.userAgent)&&($(".main").prepend($(".langBtnBox").css("position",null)),$(".donateWidget").css("position",null)),CLog("initMainUI",0,Lang("OK","OK")),A(),acmeReadDirGotoCORSInit(),downloadFileNameShow(),i(),c(),y()};var o,i=function(){$("input[name=choice_acmeURL]").bind("click",function(e){var t=e.target,a="manual"==t.value;$(".in_acmeURL").css("opacity",a?1:.4).val(a?o:t.value).attr("readonly",a?null:"");var n=$(t).attr("desckey");$(".descAcmeURL").hide(),n&&$("."+n).show(),o="",f()}),r()},r=function(){o=n.acmeURL||window.Default_ACME_URL||localStorage[e]||"";var t=$("input[name=choice_acmeURL]"),a=0;if(o){for(var i=0,r=0;r<t.length;r++)t[r].value==o&&(a=r+1),"manual"==t[r].value&&(i=r+1);a||(a=i),a--}t[a].click()},c=function(){$(".privateKeyBox").hide(),$("input[name=choice_privateKey]").bind("click",function(e){var t=e.target,a="manual"==t.value;$(".in_privateKey").css("opacity",a?1:.4).val("").attr("readonly",a?null:""),$(".privateKeyBox").show(),C(t.value),h()}),$(".accountKeyBox").hide(),$("input[name=choice_accountKey]").bind("click",function(e){var t=e.target,a="manual"==t.value;$(".in_accountKey").css("opacity",a?1:.4).val("").attr("readonly",a?null:""),$(".accountKeyBox").show(),L(t.value),h()})},u=function(){return"<span>"+Lang("继续"," ")+"</span>"},l=function(){return Lang(" 请稍候... ","")},s=function(){return Lang(" 请重试！","")},p=function(e,t,a,n){var o=new Date,i=("0"+o.getHours()).substr(-2)+":"+("0"+o.getMinutes()).substr(-2)+":"+("0"+o.getSeconds()).substr(-2);return $(e).html(!1===t?"":'<div style="color:'+(a?1==a?"red":2==a?"#0b1":3==a?"#fa0":a:"")+'">'+(null==n?"["+i+"] ":n)+t+"</div>"),t};window.Toast=function(e,t,a){p(".toastState",e,t,""),$(".toastState").show(),clearTimeout(Toast._int),Toast._int=setTimeout(function(){$(".toastState").hide()},a||5e3)},window.onerror=function(e,t,a,n,o){Toast("【Uncaught Error】"+e+"<pre>at:"+a+":"+n+" url:"+t+"\n"+(o&&o.stack||"-")+"</pre>",1,15e3)};var g=0,d=function(e,t,a){if(e!=g){var n=Lang("被终止","",1);return CLog(t+" "+n,3,"From: "+a+" ["+n+"]"),!0}},f=function(){g++,$(".step1Hide").hide(),$(".step1Show").show(),p(".acmeReadDirState",!1),$(".in_acmeURL").val()&&acmeReadDirClick()};window.acmeReadDirClick=function(){var t=++g;$(".step1Hide").hide(),$(".step1Show").show();var a="Step-1",n=".acmeReadDirState",o=$(".in_acmeURL").val().trim();if(o){localStorage[e]=o,o=ACME.URL=o.replace(/\/$/,"");var i,r=CLog(a,0,p(n,l()+Lang("正在初始化，"," ")+" URL="+ACME.URL,2)),c=function(){ACME.Directory(function(e,t){i=function(a,n){e.corsOK=a?1:-1,e.corsError=n||"",t()},1==e.corsOK?f():-1==e.corsOK?L(e.corsError,!0):C()},function(e,o){d(t,a,r+" err: "+e)||(0===o?(CLog(a,1,p(n,Lang("初始化出错：无法访问此URL。","")+s(),1)),acmeReadDirGotoCORS(Lang("如果你可以在浏览器中直接打开并访问此ACME服务URL，代表此ACME服务对跨域访问支持不良，则请按下面步骤操作：",""))):CLog(a,1,p(n,Lang("初始化出错："+e,"")+s(),1)))})},f=function(){d(t,a,r)||(h(),CLog(a,0,p(n,Lang("正常，"," ")+u(),2),ACME.DirData))},C=function(){d(t,a,r)||(r=CLog(a,0,p(n,l()+Lang("正在测试浏览器支持情况，","")+" URL="+ACME.URL,2)),ACME.GetNonce(!0,function(){ACME.TestAccountCORS(function(){CLog(a,0,Lang("此 ACME 服务对浏览器的支持良好。","")),i(!0),f()},L)},function(e,t){t&&i(!1,e),L(e,t)}))},L=function(e,o){d(t,a,r+" err: "+e)||(CLog(a,1,p(n,Lang("测试此ACME服务对浏览器的支持情况，发生错误："+e,"")+(o?"":s()),1)),LangReview(n),o&&acmeReadDirGotoCORS())};c()}else p(n,Lang("请填写服务URL！",""),1)};var h=function(){document.getElementById("q-steps1").style.display="none",document.getElementById("q-steps2").style.display="",$(".step2Hide").hide(),$(".step2Show").show(),p(".configStepState",!1),$(".eabShow")[ACME.StepData.needEAB?"show":"hide"](),n.eabKid&&$(".in_eab_kid").val(n.eabKid),n.eabKey&&$(".in_eab_key").val(n.eabKey),$(".termsAgreeBox")[ACME.StepData.termsURL?"show":"hide"](),$(".termsAgreeTips").html(Lang('我同意此证书颁发机构ACME服务的<a href="'+ACME.StepData.termsURL+'" target="_blank">服务条款</a>。',"")),$(".choice_termsAgree").prop("checked",!0);var e=$(".in_domains"),o=localStorage[t],i=n.domains&&n.domains.join(", ")||o;e.val()||e.val(i||""),$(".choice_domains_store").prop("checked",!!o);e=$(".in_email"),o=localStorage[a],i=n.email||o;e.val()||e.val(i||""),$(".choice_email_store").prop("checked",!!o);var r=function(e){n[e]&&($("input[name=choice_"+e+"][value=manual]")[0].click(),$(".in_"+e).val(n[e]))};r("privateKey"),r("accountKey"),n={}},C=function(e){var t,a=++g,n="Step-2",o=".privateKeyState",i="";if("generateRSA"==e)e="RSA",t=X509.DefaultType2_RSA,i=Lang("证书 RSA 私钥 ("+t+" Bit)"," ");else{if("generateECC"!=e)return void p(o,!1);e="ECC",t=X509.DefaultType2_ECC;var r=X509.SupportECCType2[t]||t;i=Lang("证书 ECC 私钥 ("+r+")"," ")}var c=CLog(n,0,p(o,l()+Lang("正在创建","")+i,2));X509.KeyGenerate(e,t,function(e){d(a,n,c)||($(".in_privateKey").val(e),CLog(n,0,p(o,i+Lang("，创建成功。",""),2),"\n"+e))},function(e){d(a,n,c+" err: "+e)||CLog(n,1,p(o,i+Lang("，发生错误："+e,""),1))})},L=function(e){var t,a=++g,n="Step-2",o=".accountKeyState",i="";if("generateRSA"==e)e="RSA",t=X509.DefaultType2_RSA,i=Lang("ACME 账户 RSA 私钥 ("+t+" Bit)"," ");else{if("generateECC"!=e)return void p(o,!1);e="ECC",t=X509.DefaultType2_ECC;var r=X509.SupportECCType2[t]||t;i=Lang("ACME 账户 ECC 私钥 ("+r+")"," ")}var c=CLog(n,0,p(o,l()+Lang("正在创建","")+i,2));X509.KeyGenerate(e,t,function(e){d(a,n,c)||($(".in_accountKey").val(e),CLog(n,0,p(o,i+Lang("，创建成功，请复制保管，下次输入自己的账户私钥。",""),2),"\n"+e))},function(e){d(a,n,c+" err: "+e)||CLog(n,1,p(o,i+Lang("，发生错误："+e,""),1))})};window.configStepClick=function(){var e=++g,n="Step-2",o=".configStepState";$(".step2Hide").hide(),$(".step2Show").show(),p(o,!1);var i=$(".in_domains").val().trim(),r=$(".choice_domains_store").prop("checked"),c=$(".in_privateKey").val().trim(),s=$(".in_accountKey").val().trim(),f=$(".in_email").val().trim(),h=$(".choice_email_store").prop("checked"),C=$(".in_eab_kid").val().trim(),L=$(".in_eab_key").val().trim(),m=$(".choice_termsAgree").prop("checked");i=i.replace(/\s+/g,",").replace(/，+/g,",").split(/,+/);for(var S=0,y={};S<i.length;S++){var E=i[S];if(E){if(y[E])return p(o,Lang("域名"+E+"重复！",""),1);if(/[:\/;]/.test(E))return p(o,Lang("域名"+E+"格式错误！",""),1);y[E]=1}else i.splice(S,1),S--}if(localStorage[t]=r?i.join(", "):"",localStorage[a]=h?f:"",!i.length)return p(o,Lang("ERROR 域名是必须项。"," "),1);if(!s)return p(o,Lang("ERROR 需要创建或输入 ACME 账户的私钥。"," "),1);if(!c)return p(o,Lang("ERROR 需要证书的私钥。"," "),1);if(!/.+@.+\..+/.test(f)||/[\s,;]/.test(f))return p(o,Lang("ERROR 需要填写电子邮箱地址。"," "),1);if(ACME.StepData.needEAB&&(!C||!L))return p(o,Lang("EAB KID and HMAC KEY not found."," "),1);if(ACME.StepData.termsURL&&!m)return p(o,Lang("ERROR 需要同意使用条款。"," "),1);var w,A,M=function(){X509.KeyParse(c,function(e){w=e,R()},function(e){p(o,Lang("ERROR 证书私钥无效",""),1)},1)},R=function(){X509.KeyParse(s,function(e){A=e,D()},function(e){p(o,Lang("ERROR 账户私钥无效，无法工作，请前往<a href='/settings/'>设置</a>页面清空数据",""),1)},1)},_=CLog(n,0,p(o,l(),2)),D=function(){d(e,n,_)||(ACME.StepData.config={domains:i,privateKey:w,accountKey:A,email:f,eabKid:C,eabKey:L},CLog(n,0,"config",ACME.StepData.config),K())},K=function(){var t=CLog(n,0,p(o,l()+Lang("调用 ACME 服务 newAccount 接口："," ")+ACME.DirData.newAccount,2));ACME.StepAccount(function(){d(e,n,t)||T()},function(a){d(e,n,t+" err: "+a)||CLog(n,1,p(o,Lang("调用 ACME 服务的 newAccount 接口："," ")+ACME.DirData.newAccount+Lang("，发生错误："+a,""),1))})},T=function(){var t,a=function(a){e==g&&(t=CLog(n,0,p(o,l()+Lang("调用 ACME 服务订单接口。"," ")+" "+a+" URL:"+ACME.DirData.newOrder,2)))};a(""),ACME.StepOrder(a,function(){d(e,n,t)||B()},function(a){d(e,n,t+" err: "+a)||CLog(n,1,p(o,Lang("调用 ACME 服务订单接口：","")+ACME.DirData.newOrder+Lang("，发生错误："+a,""),1))})},B=function(){v(),CLog(n,0,p(o,Lang("配置完成，","")+u(),2),ACME.StepData)};M()};var m,v=function(){document.getElementById("q-steps2").style.display="none",document.getElementById("q-steps3").style.display="",$(".step3Hide").hide(),$(".step3Show").show(),$(".verifyStepBtn").show(),$(".verifyRunStopBtn").hide(),$(".finalizeOrderBtn").hide(),p(".verifyStepState",!1),verifyBoxShow()};window.verifyRunStopClick=function(){++g;$(".verifyStepBtn").show(),$(".verifyRunStopBtn").hide(),$(".finalizeOrderBtn").hide(),p(".verifyStepState",!1),m&&m()},window.verifyStepClick=function(){var e=++g,t="Step-3",a=".verifyStepState";$(".step3Hide").hide(),$(".step3Show").show(),$(".verifyStepBtn").hide(),$(".verifyRunStopBtn").show(),$(".finalizeOrderBtn").hide(),p(a,!1);var n=ACME.StepData.config.domains,o=ACME.StepData.auths,i=function(i,r,c){for(var u=r||e!=g,l=0,s=0,d=0,f=0;f<n.length;f++){var h=n[f],C=o[h],L=C.challenges,m=$(".verifyItemState_"+f);if(11!=C.authState){if(i){for(var v=$("input[name=choice_authItem_"+f+"]"),S=0;S<v.length;S++){var y=v[S];y.checked?C.challIdx=+$(y).attr("challidx"):$(y.parentNode).hide()}C.authState=0,C.authTryCount=0,C.authError="",C.authTimer=0}var E=ACME.ChallName(L[C.challIdx]);12!=C.authState?(d++,u?(p(m,!1),clearTimeout(C.authTimer),C.authTimer=0):2==C.authState?p(m,Lang("等待重试中...","")+" "+C.authTryCount+" "+C.authError,3,""):1==C.authState?p(m,Lang("验证中...",""),0,""):p(m,Lang("等待验证...",""),0,"")):(p(m,E+Lang("，验证失败：","")+C.authError,1,""),s++)}else p(m,ACME.ChallName(L[C.challIdx])+" OK!",2,""),l++}if(!u||r){var w=Lang("请重试"," "),A=p(a,(c?Lang("验证失败，","")+w:u?Lang("已取消，","Canceled, ")+w:Lang("正在验证，请耐心等待... ",""))+"<div>"+Lang("验证通过：","")+l+", "+Lang("未通过：","")+s+", "+Lang("验证中：","")+d+"</div>",u?1:0);u&&CLog(t,1,A)}};i(1);var r=function(){if(e==g){i();for(var t,a=0,c=0,u=0,l=0;l<n.length;l++){var s=n[l],p=o[s];t||p.authState||(t=p),1==p.authState&&a++,11==p.authState&&c++,12==p.authState&&u++}return c==n.length?h():c+u==n.length?f():void(t&&!a&&(t.authState=1,t.authTryCount++,t.authError="",i(),ACME.StepVerifyAuthItem(t,t.challIdx,function(a,n,o){e==g&&(a?t.authState=11:(t.authState=2,t.authError=o,t.authTimer=setTimeout(function(){t.authState=0,t.authTimer=0,r()},n)),r())},function(a){e==g&&(t.authState=12,t.authError=a,r())})))}};CLog(t,0,"==========Verify Start==========");var c=function(){$(".verifyRunStopBtn").hide(),m=null,CLog(t,0,"==========Verify End==========")};m=function(){c(),i(0,1)};var f=function(){CLog(t,1,"Verify Fail!"),i(0,1,1),c()},h=function(){CLog(t,0,"Verify OK!"),c(),finalizeOrderClick()};window.finalizeOrderClick=function(){$(".finalizeOrderBtn").hide();var n,o=function(o){e==g&&(n=CLog(t,0,p(a,l()+Lang("验证已通过，正在签发证书。","")+" "+o,2)))};o(""),ACME.StepFinalizeOrder(o,function(){d(e,t,n)||(S(),CLog(t,0,p(a,Lang("验证已通过，证书已签发，","")+u(),2),ACME.StepData))},function(o){d(e,t,n+" err: "+o)||($(".finalizeOrderBtn").show(),CLog(t,1,p(a,Lang("签发证书发生错误，","")+s()+Lang("如果多次重试都无法签发证书，请直接刷新页面重新开始。","")+" Error: "+o,1)))})},r()};var S=function(){document.getElementById("q-steps2").style.display="none",document.getElementById("q-steps3").style.display="none",document.getElementById("q-steps4").style.display="",$(".step4Hide").hide(),$(".step4Show").show(),p(".downloadStepState",!1);var e=ACME.StepData.config,t=ACME.StepData.order.downloadPEM,a=t||Lang("未发现证书，请刷新页面重新开始。","",!0);let n=(new Date).toISOString(),o={cert:a,key:e.privateKey.pem,time:n,domains:e.domains},i=JSON.parse(localStorage.getItem("q-manageDataPairs"))||[];i.push(o),localStorage.setItem("q-manageDataPairs",JSON.stringify(i)),$(".txt_downloadCert").val(a),$(".txt_downloadKey").val(e.privateKey.pem),E=e.domains[0].replace(/^\*\./g,"").replace(/[^\w]/g,"_"),downloadFileNameShow(E);var r=[],c=function(e){return r.push("\n=========== "+e+" ==========="),r},u=Object.assign({acmeURL:ACME.URL,accountURL:ACME.StepData.account.url,X509:{DefaultType2_RSA:X509.DefaultType2_RSA,DefaultType2_ECC:X509.DefaultType2_ECC},Window:{DefaultDownloadFileNames:DefaultDownloadFileNames}},e);u.privateKey=e.privateKey.pem,u.accountKey=e.accountKey.pem;var l="/********** "+Lang($(".clientNameCN").html(),$(".clientNameEN").html(),!0)+" *********/";r.push(l),r.push(Lang("在线网址（GitHub）：","",!0)+"https://xiangyuecn.github.io/ACME-HTML-Web-Browser-Client/ACME-HTML-Web-Browser-Client.html"),r.push(Lang("在线网址（Gitee）：","",!0)+"https://xiangyuecn.gitee.io/acme-html-web-browser-client/ACME-HTML-Web-Browser-Client.html"),r.push(""),r.push("GitHub: https://github.com/xiangyuecn/ACME-HTML-Web-Browser-Client"),r.push("Gitee: https://gitee.com/xiangyuecn/ACME-HTML-Web-Browser-Client"),r.push(""),r.push(Lang("提示：你可以将本文件拖拽进客户端网页内，将自动填充本次证书申请的所有配置参数。","",!0)),r.push(""),c(Lang("证书申请时间","",!0)).push((new Date).toLocaleString()),c(Lang("域名列表","",!0)).push(e.domains.join(", ")),c(Lang("ACME服务地址","",!0)).push(ACME.URL),c(Lang("CSR文本","",!0)).push(ACME.StepData.order.orderCSR),c(Lang("证书PEM文本","",!0)).push(a),c(Lang("证书私钥PEM文本","",!0)).push(e.privateKey.pem),c(Lang("账户私钥PEM文本","",!0)).push(e.accountKey.pem),c(Lang("账户URL","",!0)).push(ACME.StepData.account.url),c(Lang("完整配置信息","",!0)).push("<ACME-HTML-Web-Browser-Client>"+JSON.stringify(u)+"</ACME-HTML-Web-Browser-Client>"),r.push(""),r.push(l),r.push(""),$(".txt_downloadLog").val(t?r.join("\n"):a)},y=function(){$("body").bind("dragover",function(e){e.preventDefault()}).bind("drop",function(e){e.preventDefault();var t=e.dataTransfer.files[0];if(t){var a=new FileReader;a.onload=function(e){var t=a.result,o=/ACME-HTML-Web-Browser-Client>(.+?)<\/ACME-HTML-Web-Browser-Client/.exec(t);if(!o)return Toast(Lang("拖入的文件中未发现配置信息，请拖上次申请证书时保存的记录LOG文件！",""),1);for(var i in n=JSON.parse(o[1]),n.X509)X509[i]=n.X509[i];for(var i in n.Window)window[i]=n.Window[i];CLog("DropConfigFile",0,"Reset Config",n),Toast(Lang("识别到拖入的记录LOG文件，已填充上次申请证书时使用的配置。",""),2),r(),downloadFileNameShow()},a.readAsText(t)}})},E="";window.DefaultDownloadFileNames={Cert:"",Key:"",Log:""},window.downloadBtnClick=function(e){var t=$(".txt_download"+e).val(),a=E;"Cert"==e&&(a+=".pem"),"Key"==e&&(a+=".key"),"Log"==e&&(a+=".log"),a=DefaultDownloadFileNames[e]||a;var n=URL.createObjectURL(new Blob([t],{type:"text/plain"})),o=document.createElement("A");o.href=n,o.download="ZSEncrypt_"+a,o.click()},window.downloadFileNameShow=function(e){e=e||"your_domain";var t=(DefaultDownloadFileNames.Cert||"").replace(/\.[^\.]+$/g,"");$(".downloadFileName").html(t||e),$(".downloadKeyFileName").html(DefaultDownloadFileNames.Key||e+".key"),$(".downloadCertFileName").html(DefaultDownloadFileNames.Cert||e+".pem")},window.Test_AllStepData_Save=function(){if(!ACME.StepData.order)throw new Error(Lang("未完成第二步操作","",!0));var e=ACME.StepData.config;delete ACME.PrevNonce,e.privateKey=e.privateKey.pem,e.accountKey=e.accountKey.pem,localStorage[w]=JSON.stringify(ACME),ACME=null,console.warn(Lang("仅供测试：已保存测试数据，需刷新页面","",!0))};var w="ACME_HTML_Test_AllStepData",A=function(){localStorage[w]&&console.warn(Lang("仅供测试：已保存测试数据，调用Test_Restore_StepXXX()进行恢复步骤界面","",!0))},M=function(e){var t=JSON.parse(localStorage[w]||"{}");if(!t.StepData)throw new Error(Lang("未保存数据","",!0));for(var a in t)ACME[a]=t[a];var n=ACME.StepData.config;X509.KeyParse(n.privateKey,function(t){n.privateKey=t,X509.KeyParse(n.accountKey,function(t){n.accountKey=t,console.log("ACME.StepData",ACME.StepData),setTimeout(function(){e()})})})};window.Test_Restore_StepAuth=function(){M(function(){console.warn(Lang("仅供测试：已手动恢复步骤三界面","",!0)),v()})},window.Test_Restore_StepDownload=function(){M(function(){console.warn(Lang("仅供测试：已手动恢复步骤四界面","",!0)),S()})}})();